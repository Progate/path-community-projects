## nginxを使ってみよう

### aptでnginxをインストールしてみよう

nginx をインストールするには、以下のコマンドを実行します。nginx とは、高性能な HTTP サーバーソフトウェアで、静的なコンテンツを配信するために使用されます。Apache HTTP Server と同様に、Web サーバーとして広く使用されています。

```sh
$ sudo apt install nginx
```

インストール時に下記のような画面が表示される場合があるので、デフォルトの選択肢で OK します。

- <img width="580" alt="image" src="https://github.com/Progate/path-community-projects/assets/26600620/823ea2a0-ed40-40bf-bf2c-bb9c0a692b88">

### nginxでphp-fpmにリバースプロキシしてみよう

リバースプロキシとは、クライアントからのリクエストを別のサーバーに転送する仕組みのことです。nginx を使用して、PHP リクエストを `php-fpm` にリバースプロキシできます。

これを実現するためには、Nginx の設定ファイル（通常は `/etc/nginx/sites-available/` ディレクトリ内のファイル）に適切な設定を追加する必要があります。

1. 設定ファイルを開く

    ```sh
    $ sudo vi /etc/nginx/sites-available/default
    ```

2. `php-fpm` にリクエストを転送する基本的な Nginx の設定を追加します。

    ```nginx
    server {
        listen 80;
        server_name example.com; # あなたのドメインに置き換えてください

        root /var/www/html; # ドキュメントルートのパス
        index index.php index.html index.htm;

        location / {
            try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;

            # UNIXドメインソケットを使用してphp-fpmにリクエストを転送
            fastcgi_pass unix:/run/php/php8.1-fpm.sock;

            # 以下のディレクティブは、環境に応じて調整してください
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }
    ```

    ```sh
    # vi を保存して終了
    :wq
    ```

    この設定では、`server_name` ディレクティブをあなたのドメイン名に、`root` ディレクティブをあなたのウェブサイトのドキュメントルートに置き換えてください。`location ~ \.php$` ブロックは、リクエストが PHP ファイルにマッチした場合に `php-fpm` に転送するように設定します。

3. 設定が正しいことを確認するために、`sudo nginx -t` コマンドを実行します。

    ```sh
    $ sudo nginx -t
    nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
    nginx: configuration file /etc/nginx/nginx.conf test is successful
    ```

4. 設定に問題がなければ、`sudo systemctl reload nginx` コマンドで Nginx を再読み込みします。

    ```sh
    $ sudo systemctl reload nginx
    ```

これで、Nginx は PHP リクエストを `php-fpm` にリバースプロキシし、PHP アプリケーションを正しく処理できるようになります。

設定反映後の `/etc/nginx/sites-available/default` の中身は以下のようになります。

```nginx
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html;
        index index.php index.html index.htm;

	# Add index.php to the list if you are using PHP

	server_name 54.238.193.253;
        location / {
          try_files $uri $uri/ =404;
        }
	location ~ \.php$ {
          include snippets/fastcgi-php.conf;

          # UNIXドメインソケットを使用してphp-fpmにリクエストを転送
          fastcgi_pass unix:/run/php/php8.1-fpm.sock;

          # 以下のディレクティブは、環境に応じて調整してください
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          include fastcgi_params;
        }

	# pass PHP scripts to FastCGI server
	#
	#location ~ \.php$ {
	#	include snippets/fastcgi-php.conf;
	#
	#	# With php-fpm (or other unix sockets):
	#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}

```

#### ブラウザからアクセスしてSERVER_SOFTWAREの値を確認してみよう

`http://your-server-ip` または `http://your-domain.com` でアクセスしてみましょう。Apatche のデフォルトのウェルカムページではなく、PHP の情報が表示されるはずです。

SERVER_SOFTWARE の値が `Apache/2.4.52 (Ubuntu)` ではなく、`nginx/1.18.0` になっていることを確認してください。

```php
["SERVER_SOFTWARE"]=> string(12) "nginx/1.18.0"
```
